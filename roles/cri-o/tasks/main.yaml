---
- include_vars: ../../vars.yaml

- name: Install Packet
  ansible.builtin.apt:
    name: "{{item}}"
    state: present
  with_items:
    - curl
    - gnupg2
  when: CNI = "cri-o"

- name: Create /etc/modules-load.d/crio.conf
  ansible.builtin.copy: 
    dest: /etc/modules-load.d/crio.conf
    content: |
      overlay
      br_netfilter
  when: CNI = "cri-o"

- name: Create /etc/sysctl.d/99-kubernetes-cri.conf
  ansible.builtin.copy: 
    dest: /etc/sysctl.d/99-kubernetes-cri.conf
    content: |
      net.bridge.bridge-nf-call-iptables  = 1
      net.ipv4.ip_forward                 = 1
      net.bridge.bridge-nf-call-ip6tables = 1
  when: CNI = "cri-o"

- name: modprode
  command: "{{ item }}"
  with_items:
    - modprobe overlay
    - modprobe br_netfilter
    - sudo sysctl --system
  when: CNI = "cri-o"

- name: Create /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list
    content: deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/{{vars.OS}}/ /
  when: CNI = "cri-o"

- name: Create /etc/apt/sources.list.d/devel:kubic:libcontainers:stable:cri-o:{{vars.OS}}.list
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/devel:kubic:libcontainers:stable:cri-o:{{vars.OS}}.list
    content: deb http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/{{vars.CRIO_VERSION}}/{{vars.OS}}/ /
  when: CNI = "cri-o"

- name: CRI-O add pgp
  ansible.builtin.apt_key:
    url: "{{ item }}"
    state: present
  with_items:
    - https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable:cri-o:{{vars.CRIO_VERSION}}/{{vars.OS}}/Release.key
    - https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/{{vars.OS}}/Release.key
  when: CNI = "cri-o"

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
  when: CNI = "cri-o"

- name: Install CRI-O
  ansible.builtin.apt:
    name: "{{item}}"
    state: present
  with_items:
    - cri-o 
    - cri-o-runc
    - cri-tools
  when: CNI = "cri-o"

- name: Start cri-o
  ansible.builtin.service:
    name: crio
    daemon_reload: true
    state: started
  when: CNI = "cri-o"

- name: Enable cri-o
  ansible.builtin.service:
    name: crio
    enabled: yes
  when: CNI = "cri-o"